<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoAgent Vehicle Search</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #111;
            --panel: #1a1a1a;
            --text: #f5f5f5;
            --muted: #9aa0a6;
            --accent: #3b82f6;
            --good: #22c55e;
            --bad: #ef4444;
            --border: #333;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        .container {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Map */
        .map-container {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Filter pills */
        .filter-pills {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-pill {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .filter-pill:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .filter-pill.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Result chip */
        .result-chip {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text);
            font-size: 14px;
            backdrop-filter: blur(10px);
            margin-bottom: 8px;
        }

        /* Bottom sheet */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--panel);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px var(--shadow);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.collapsed {
            transform: translateY(calc(100% - 160px));
        }

        .bottom-sheet.mid {
            transform: translateY(calc(100% - 55vh));
        }

        .bottom-sheet.expanded {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--muted);
            border-radius: 2px;
            margin: 12px auto;
            cursor: pointer;
        }

        .sheet-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Carousel (collapsed state) */
        .carousel {
            display: flex;
            gap: 16px;
            padding: 0 16px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            height: 120px;
            align-items: center;
        }

        .carousel::-webkit-scrollbar {
            display: none;
        }

        /* List (mid/expanded state) */
        .list {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
        }

        .list.hidden {
            display: none;
        }

        /* Vehicle card */
        .vehicle-card {
            background: var(--bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.2s;
            cursor: pointer;
            scroll-snap-align: start;
            min-width: 280px;
            margin-bottom: 16px;
        }

        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow);
        }

        .vehicle-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .vehicle-card.carousel-card {
            min-width: 200px;
            margin-bottom: 0;
        }

        .card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: var(--border);
        }

        .card-content {
            padding: 12px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .price-badge {
            background: var(--accent);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .vehicle-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .vehicle-subtitle {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .dealer-info {
            font-size: 12px;
            color: var(--muted);
        }

        .distance {
            font-size: 12px;
            color: var(--good);
        }

        /* Details drawer */
        .details-drawer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--panel);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .details-drawer.open {
            transform: translateY(0);
        }

        .drawer-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .drawer-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .spec-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .spec-label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .spec-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .features {
            margin-bottom: 16px;
        }

        .features-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .feature-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .feature-chip {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            color: var(--text);
        }

        .dealer-block {
            background: var(--bg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .dealer-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .dealer-address {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 12px;
        }

        .dealer-actions {
            display: flex;
            gap: 8px;
        }

        .dealer-btn {
            flex: 1;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dealer-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .cta-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .cta-primary {
            flex: 1;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cta-primary:hover {
            background: #2563eb;
        }

        .cta-secondary {
            flex: 1;
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cta-secondary:hover {
            background: var(--bg);
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--muted);
            text-align: center;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Skeletons */
        .skeleton {
            background: linear-gradient(90deg, var(--border) 25%, var(--panel) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .skeleton-image {
            height: 120px;
            border-radius: 12px 12px 0 0;
        }

        .skeleton-content {
            padding: 12px;
        }

        .skeleton-line {
            height: 16px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-line.short {
            width: 60%;
        }

        /* Lead form modal */
        .lead-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .lead-modal.open {
            display: flex;
        }

        .lead-form {
            background: var(--panel);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .lead-form h3 {
            margin-bottom: 20px;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .form-checkbox input {
            width: 16px;
            height: 16px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .vin-display {
            background: var(--bg);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .vin-masked {
            color: var(--good);
        }

        .success-message {
            background: var(--good);
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: none;
        }

        .error-message {
            background: var(--bad);
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-pills {
                flex-wrap: wrap;
            }
            
            .vehicle-card {
                min-width: 250px;
            }
            
            .specs-grid {
                grid-template-columns: 1fr;
            }

            .lead-modal {
                padding: 10px;
            }

            .lead-form {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <script>
    (function(){
      const params = new URLSearchParams(location.search);
      const RID = params.get('rid') || 'none';
      const DIAG = params.get('diag') === '1';
      const T0 = performance.now();
      let emitted = false;
      const MAX_WAIT_MS = 5000, INTERVAL_MS = 150;

      function post(path, body){
        try{ fetch(`${path}?rid=${encodeURIComponent(RID)}`, {method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)}).catch(()=>{});}catch(_){}
      }
      function log(...a){
        try{ (window.__log ||= []).push({t:performance.now(),m:a.join(' ')}); post('/widget/console', window.__log); }catch(_){}
      }
      function beacon(tag, extra){
        post('/widget/beacon', Object.assign({ rid: RID, tag, t: performance.now() }, extra||{}));
      }
      function getResults(){
        try{
          if (window.openai && window.openai.toolOutput) {
            return window.openai.toolOutput.structuredContent?.results || null;
          }
        }catch(e){ log('ERR getResults', e?.message||e); }
        return window.__AA_MOCK__||null;
      }
      function maybeEmitReady(tag){
        if (emitted) return;
        if (!(window.openai && typeof window.openai.emitToolEvent==='function')) return;
        try{
          window.openai.emitToolEvent('ui:ready', { ok:true, tag, rid: RID, elapsedMs: performance.now()-T0 });
          emitted = true;
          beacon('ui-ready:'+tag);
          log('ui:ready emitted', tag);
        }catch(e){ log('ERR emit', e?.message||e); }
      }
      function render(){
        const results = getResults();
        if (!results) return false;
        // In DIAG mode, skip heavy map/photos entirely to isolate validator timing:
        if (DIAG){
          const el = document.createElement('div');
          el.id = 'diag';
          el.textContent = `DIAG render (rid=${RID}) vehicles=${results.totalCount ?? results.vehicles?.length ?? 'n/a'}`;
          el.setAttribute('data-aa-results','1');
          document.body.appendChild(el);
          requestAnimationFrame(()=> maybeEmitReady('rendered-diag'));
          return true;
        }
        // TODO: your normal render path (map/list). After first paint:
        requestAnimationFrame(()=> maybeEmitReady('rendered'));
        return true;
      }
      function heartbeat(){
        const haveBridge = !!(window.openai && window.openai.emitToolEvent);
        const haveData = !!getResults();
        if (haveBridge) maybeEmitReady('bridge');
        if (haveData) render();
        if (!emitted){
          if (performance.now()-T0 < MAX_WAIT_MS){ setTimeout(heartbeat, INTERVAL_MS); }
          else { beacon('timeout-fallback'); maybeEmitReady('timeout-fallback'); }
        }
      }

      window.addEventListener('error', e=>{ log('window.error', e?.message||e); beacon('error',{msg:e?.message||'error'}); });
      window.addEventListener('unhandledrejection', e=>{ log('unhandledrejection', String(e?.reason||e)); beacon('error',{msg:String(e?.reason||e)}); });

      document.addEventListener('DOMContentLoaded', ()=>{ log('DOMContentLoaded', `rid=${RID}`, `diag=${DIAG}`); beacon('domcontentloaded'); heartbeat(); });
      window.addEventListener('load', ()=>{ log('window.load'); beacon('window.load'); heartbeat(); });

      // extra environment breadcrumbs
      log('ua', navigator.userAgent);
      log('href', location.href);
      log('referrer', document.referrer);
    })();
    </script>

    <div class="container">
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Result chip -->
            <div class="result-chip" id="resultChip" style="display: none;">
                <span id="resultCount">0</span> matches • <span id="resultLocation">Loading...</span>
            </div>
            
            <!-- Filter pills -->
            <div class="filter-pills">
                <div class="filter-pill" data-filter="condition">Condition</div>
                <div class="filter-pill" data-filter="price">Max Price</div>
                <div class="filter-pill" data-filter="radius">Radius</div>
                <div class="filter-pill" data-filter="make">Make/Model</div>
                <div class="filter-pill" data-filter="filters">Filters</div>
            </div>
        </div>

        <!-- Bottom sheet -->
        <div class="bottom-sheet collapsed" id="bottomSheet" role="dialog" aria-expanded="false">
            <div class="sheet-handle" id="sheetHandle"></div>
            <div class="sheet-content">
                <!-- Carousel (collapsed) -->
                <div class="carousel" id="carousel"></div>
                
                <!-- List (mid/expanded) -->
                <div class="list" id="list"></div>
            </div>
        </div>

        <!-- Details drawer -->
        <div class="details-drawer" id="detailsDrawer" aria-expanded="false">
            <div class="drawer-header">
                <h3 id="drawerTitle">Vehicle Details</h3>
                <button class="drawer-close" id="drawerClose">&times;</button>
            </div>
            <div class="drawer-content" id="drawerContent"></div>
        </div>

        <!-- Lead form modal -->
        <div class="lead-modal" id="leadModal">
            <div class="lead-form">
                <h3>Book Test Drive</h3>
                
                <div class="success-message" id="successMessage">
                    Request sent! The dealer will reach out shortly.
                </div>
                
                <div class="error-message" id="errorMessage">
                    There was an error submitting your request. Please try again.
                </div>

                <div class="vin-display" id="vinDisplay" style="display: none;">
                    VIN: <span id="vinValue"></span>
                </div>

                <form id="leadForm">
                    <div class="form-group">
                        <label class="form-label" for="leadName">Full Name *</label>
                        <input type="text" id="leadName" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="leadEmail">Email *</label>
                        <input type="email" id="leadEmail" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="leadPhone">Phone Number</label>
                        <input type="tel" id="leadPhone" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="leadTime">Preferred Contact Time</label>
                        <input type="text" id="leadTime" class="form-input" placeholder="e.g., Weekday mornings, Weekend afternoons">
                    </div>

                    <div class="form-checkbox">
                        <input type="checkbox" id="leadConsent" required>
                        <label for="leadConsent">I agree to be contacted by the dealer regarding this vehicle</label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeLeadModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submitButton">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const MAX_WAIT_MS = 5000;     // total time to try emitting ui:ready
            const INTERVAL_MS = 200;      // poll interval for bridge/data
            let emitted = false;
            const startedAt = Date.now();

            // ---- logging helpers ----
            function post(path, body){
                try {
                    fetch(path, {
                        method:'POST',
                        headers:{'content-type':'application/json'},
                        body: JSON.stringify(body)
                    }).catch(()=>{});
                } catch(_) {}
            }
            function log(...args){
                try {
                    console.log('[vehicle-widget]', ...args);
                    (window.__log ||= []).push({ts:Date.now(),msg:args.map(String).join(' ')});
                    post('/widget/console', window.__log);
                } catch(_) {}
            }
            function warn(...args){ try{ console.warn('[vehicle-widget]', ...args); }catch(_){} }
            function errorLog(e){ try{ console.error('[vehicle-widget]', e); log('ERROR', e?.message||e); }catch(_){} }

            // ---- data access ----
            function getResults() {
                try {
                    if (window.openai && window.openai.toolOutput) {
                        return window.openai.toolOutput.structuredContent?.results || null;
                    }
                } catch (e) { errorLog(e); }
                // local dev fallback
                return window.__AA_MOCK__ || null;
            }

            // ---- emit readiness to ChatGPT ----
            function maybeEmitReady(tag) {
                if (emitted) return;
                const bridge = window.openai && typeof window.openai.emitToolEvent === 'function';
                if (!bridge) return;
                try {
                    window.openai.emitToolEvent('ui:ready', {
                        ok: true, tag, ts: Date.now(), elapsedMs: Date.now() - startedAt
                    });
                    emitted = true;
                    log('ui:ready emitted', tag);
                    // beacon for server visibility
                    post('/widget/beacon', { tag: 'ui-ready:'+tag, ts: Date.now() });
                } catch (e) { errorLog(e); }
            }

            // ---- render once data exists ----
            function render() {
                const results = getResults();
                if (!results) return false;
                // TODO: your existing map/list render using `results`
                // mark the container so MutationObserver can latch onto it if you want
                // document.querySelector('#results')?.setAttribute('data-aa-results','1');

                // after first paint, confirm ready again
                requestAnimationFrame(() => maybeEmitReady('rendered'));
                return true;
            }

            // ---- heartbeat: poll for bridge+data, never hang ----
            function heartbeat() {
                const haveBridge = !!(window.openai && window.openai.emitToolEvent);
                const haveData   = !!getResults();

                // emit as soon as bridge is present (don't wait for data)
                if (haveBridge) { maybeEmitReady('bridge'); }
                // render when data shows up
                if (haveData) { render(); }

                const elapsed = Date.now() - startedAt;
                if (!emitted && elapsed < MAX_WAIT_MS) {
                    setTimeout(heartbeat, INTERVAL_MS);
                } else if (!emitted) {
                    // last-ditch: emit so validator doesn't time out
                    warn('ui:ready timeout fallback');
                    maybeEmitReady('timeout-fallback');
                }
            }

            // ---- lifecycle hooks ----
            document.addEventListener('DOMContentLoaded', () => { log('DOMContentLoaded'); heartbeat(); });
            window.addEventListener('load', () => { log('window.load'); heartbeat(); });

            // global error trap
            window.addEventListener('error', (e) => errorLog(e?.error||e?.message||e));
        })();
    </script>
    <script type="module">
        // Utilities
        const el = (id) => document.getElementById(id);
        const fmtPrice = (price) => {
            if (price >= 1000) {
                return `$${(price / 1000).toFixed(1)}k`;
            }
            return `$${price.toLocaleString()}`;
        };
        const kmToMiles = (km) => (km * 0.621371).toFixed(1);
        const safeText = (text) => text || '';

        // State management
        const state = {
            activeId: null,
            sheetState: 'collapsed', // collapsed, mid, expanded
            vehicles: [],
            query: {},
            map: null,
            markers: []
        };

        // Mock data for testing
        const mockVehicles = [
            {
                id: '1',
                year: 2022,
                make: 'Toyota',
                model: 'Camry',
                price: 28500,
                mileage: 15000,
                imageUrl: 'https://images.unsplash.com/photo-1621007947382-bb3c3994e3fb?w=400',
                features: ['Bluetooth', 'Backup Camera', 'Lane Assist'],
                vin: '1HGCM82633A004352',
                dealer: {
                    name: 'Seattle Auto Center',
                    address: '123 Main St, Seattle, WA 98101',
                    lat: 47.6062,
                    lng: -122.3321,
                    distanceMiles: 2.3
                }
            },
            {
                id: '2',
                year: 2021,
                make: 'Honda',
                model: 'CR-V',
                price: 32000,
                mileage: 22000,
                imageUrl: 'https://images.unsplash.com/photo-1606664515524-ed2f786a0bd6?w=400',
                features: ['AWD', 'Sunroof', 'Heated Seats'],
                vin: '2HGFC2F59MH543210',
                dealer: {
                    name: 'Bellevue Motors',
                    address: '456 Auto Way, Bellevue, WA 98004',
                    lat: 47.6101,
                    lng: -122.2015,
                    distanceMiles: 5.7
                }
            },
            {
                id: '3',
                year: 2023,
                make: 'Subaru',
                model: 'Outback',
                price: 35000,
                mileage: 5000,
                imageUrl: 'https://images.unsplash.com/photo-1618843479313-40f8afb4b4d8?w=400',
                features: ['AWD', 'Eyesight Safety', 'Apple CarPlay'],
                vin: '4S4BSANC9P3245678',
                dealer: {
                    name: 'Tacoma Auto Group',
                    address: '789 Car Blvd, Tacoma, WA 98402',
                    lat: 47.2529,
                    lng: -122.4443,
                    distanceMiles: 12.1
                }
            }
        ];

        // Load data from OpenAI tool output with retry logic
        function loadData() {
            let retryCount = 0;
            const maxRetries = 3;
            
            function attemptLoad() {
                try {
                    const results = getResults();
                    if (results) {
                        state.vehicles = results.vehicles || results;
                        state.query = results.searchParams || results.query || {};
                        console.log('Data loaded successfully');
                    } else if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Retrying data load (${retryCount}/${maxRetries})...`);
                        setTimeout(attemptLoad, 500);
                        return;
                    } else {
                        // Final fallback to mock data
                        console.log('Using fallback mock data');
                        state.vehicles = mockVehicles;
                        state.query = {
                            location: 'Seattle, WA',
                            condition: 'used',
                            maxPrice: 30000
                        };
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(attemptLoad, 500);
                    } else {
                        state.vehicles = mockVehicles;
                        state.query = { location: 'Seattle, WA' };
                    }
                }
            }
            
            attemptLoad();
        }

        // Initialize map
        function initMap() {
            state.map = L.map('map').setView([47.6062, -122.3321], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(state.map);

            // Add markers for vehicles with coordinates
            state.vehicles.forEach(vehicle => {
                if (vehicle.dealer.lat && vehicle.dealer.lng) {
                    const marker = L.marker([vehicle.dealer.lat, vehicle.dealer.lng])
                        .bindPopup(`
                            <div style="text-align: center;">
                                <strong>${vehicle.year} ${vehicle.make} ${vehicle.model}</strong><br>
                                <span style="color: #3b82f6; font-weight: bold;">${fmtPrice(vehicle.price)}</span>
                            </div>
                        `)
                        .on('click', () => {
                            logEvent('pin_click', { id: vehicle.id });
                            setActiveVehicle(vehicle.id);
                            scrollToCard(vehicle.id);
                        });
                    
                    state.markers.push(marker);
                    marker.addTo(state.map);
                }
            });

            // Fit map to show all markers
            if (state.markers.length > 0) {
                const group = new L.featureGroup(state.markers);
                state.map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Set active vehicle
        function setActiveVehicle(id) {
            state.activeId = id;
            
            // Update card selection
            document.querySelectorAll('.vehicle-card').forEach(card => {
                card.classList.toggle('active', card.dataset.id === id);
            });
            
            // Update marker selection
            state.markers.forEach((marker, index) => {
                if (state.vehicles[index].id === id) {
                    marker.setIcon(L.divIcon({
                        className: 'active-marker',
                        html: '<div style="background: #3b82f6; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px;"></div>',
                        iconSize: [20, 20]
                    }));
                } else {
                    marker.setIcon(L.divIcon({
                        className: 'default-marker',
                        html: '<div style="background: #ef4444; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px;"></div>',
                        iconSize: [16, 16]
                    }));
                }
            });
        }

        // Scroll to card
        function scrollToCard(id) {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Create vehicle card HTML
        function createCardHTML(vehicle) {
            return `
                <article class="vehicle-card" data-id="${vehicle.id}" onclick="openDetails('${vehicle.id}')">
                    <img src="${vehicle.imageUrl || '/placeholder-car.jpg'}" 
                         alt="${vehicle.year} ${vehicle.make} ${vehicle.model}" 
                         class="card-image"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhciBJbWFnZTwvdGV4dD48L3N2Zz4='">
                    <div class="card-content">
                        <div class="card-header">
                            <div>
                                <div class="vehicle-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                                <div class="vehicle-subtitle">${vehicle.mileage ? vehicle.mileage.toLocaleString() + ' miles' : 'New'}</div>
                            </div>
                            <div class="price-badge">${fmtPrice(vehicle.price)}</div>
                        </div>
                        <div class="dealer-info">
                            <div>${safeText(vehicle.dealer.name)}</div>
                            ${vehicle.dealer.distanceMiles ? `<div class="distance">${vehicle.dealer.distanceMiles} mi away</div>` : ''}
                        </div>
                    </div>
                </article>
            `;
        }

        // Render cards
        function renderCards() {
            const carousel = el('carousel');
            const list = el('list');
            
            if (state.vehicles.length === 0) {
                carousel.innerHTML = '<div class="empty-state"><div class="empty-icon">🚗</div><div>No matches. Try expanding radius or increasing max price.</div></div>';
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">🚗</div><div>No matches. Try expanding radius or increasing max price.</div></div>';
                return;
            }

            const cardsHTML = state.vehicles.map(vehicle => createCardHTML(vehicle)).join('');
            
            carousel.innerHTML = cardsHTML;
            list.innerHTML = cardsHTML;
            
            // Emit ui:ready event after first paint
            setTimeout(() => {
                onReady();
            }, 100);
        }

        // Open details drawer
        function openDetails(id) {
            logEvent('card_click', { id });
            
            const vehicle = state.vehicles.find(v => v.id === id);
            if (!vehicle) return;

            const drawer = el('detailsDrawer');
            const title = el('drawerTitle');
            const content = el('drawerContent');

            title.textContent = `${vehicle.year} ${vehicle.make} ${vehicle.model}`;
            
            content.innerHTML = `
                <img src="${vehicle.imageUrl || '/placeholder-car.jpg'}" 
                     alt="${vehicle.year} ${vehicle.make} ${vehicle.model}" 
                     class="drawer-image"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhciBJbWFnZTwvdGV4dD48L3N2Zz4='">
                
                <div class="specs-grid">
                    <div class="spec-item">
                        <div class="spec-label">Year</div>
                        <div class="spec-value">${vehicle.year}</div>
                    </div>
                    <div class="spec-item">
                        <div class="spec-label">Mileage</div>
                        <div class="spec-value">${vehicle.mileage ? vehicle.mileage.toLocaleString() + ' mi' : 'New'}</div>
                    </div>
                    <div class="spec-item">
                        <div class="spec-label">Price</div>
                        <div class="spec-value">${fmtPrice(vehicle.price)}</div>
                    </div>
                    <div class="spec-item">
                        <div class="spec-label">Condition</div>
                        <div class="spec-value">${vehicle.mileage ? 'Used' : 'New'}</div>
                    </div>
                </div>

                ${vehicle.features && vehicle.features.length > 0 ? `
                    <div class="features">
                        <div class="features-title">Key Features</div>
                        <div class="feature-chips">
                            ${vehicle.features.slice(0, 6).map(feature => `<span class="feature-chip">${feature}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}

                <div class="dealer-block">
                    <div class="dealer-name">${safeText(vehicle.dealer.name)}</div>
                    ${vehicle.dealer.address ? `<div class="dealer-address">${vehicle.dealer.address}</div>` : ''}
                    <div class="dealer-actions">
                        <button class="dealer-btn" onclick="callDealer('${vehicle.id}')">Call</button>
                        <button class="dealer-btn" onclick="getDirections('${vehicle.id}')">Directions</button>
                    </div>
                </div>

                <div class="cta-buttons">
                        <button class="cta-primary" onclick="bookTestDrive('${vehicle.id}')" ${!vehicle.vin ? 'disabled title="VIN unavailable from source"' : ''}>
                            ${vehicle.vin ? 'Book Test Drive' : 'VIN Required'}
                        </button>
                        <button class="cta-secondary" onclick="getQuote('${vehicle.id}')" ${!vehicle.vin ? 'disabled title="VIN unavailable from source"' : ''}>
                            Get Quote
                        </button>
                </div>
            `;

            drawer.classList.add('open');
            drawer.setAttribute('aria-expanded', 'true');
        }

        // Close details drawer
        function closeDetails() {
            const drawer = el('detailsDrawer');
            drawer.classList.remove('open');
            drawer.setAttribute('aria-expanded', 'false');
        }

        // Book test drive
        function bookTestDrive(id) {
            const vehicle = state.vehicles.find(v => v.id === id);
            if (!vehicle) return;

            // Check if VIN is available
            if (!vehicle.vin) {
                alert('VIN unavailable from source. Cannot proceed with test drive request.');
                return;
            }

            logEvent('lead_start', { id });
            openLeadModal(vehicle);
        }

        // Get quote
        function getQuote(id) {
            logEvent('quote_start', { id });
            window.openai?.emitToolEvent('quote:start', { vehicleId: id });
            console.log('quote:start', { vehicleId: id });
        }

        // Call dealer
        function callDealer(id) {
            logEvent('dealer_call', { id });
            console.log('dealer_call', { id });
        }

        // Get directions
        function getDirections(id) {
            logEvent('dealer_directions', { id });
            console.log('dealer_directions', { id });
        }

        // Lead modal functions
        let currentVehicle = null;

        function openLeadModal(vehicle) {
            currentVehicle = vehicle;
            const modal = el('leadModal');
            const vinDisplay = el('vinDisplay');
            const vinValue = el('vinValue');
            
            // Show VIN if available
            if (vehicle.vin) {
                vinDisplay.style.display = 'block';
                vinValue.textContent = vehicle.vin;
            } else {
                vinDisplay.style.display = 'none';
            }
            
            // Reset form
            el('leadForm').reset();
            el('successMessage').style.display = 'none';
            el('errorMessage').style.display = 'none';
            
            modal.classList.add('open');
        }

        function closeLeadModal() {
            const modal = el('leadModal');
            modal.classList.remove('open');
            currentVehicle = null;
        }

        async function submitLead(event) {
            event.preventDefault();
            
            const submitButton = el('submitButton');
            const successMessage = el('successMessage');
            const errorMessage = el('errorMessage');
            
            // Disable submit button
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            
            try {
                const formData = {
                    vehicleId: currentVehicle.id,
                    vin: currentVehicle.vin,
                    dealerId: currentVehicle.dealerId || currentVehicle.dealer?.id,
                    user: {
                        name: el('leadName').value,
                        email: el('leadEmail').value,
                        phone: el('leadPhone').value || undefined,
                        preferredTime: el('leadTime').value || undefined,
                    },
                    consent: el('leadConsent').checked,
                };

                // Try to submit via MCP tool
                const response = await fetch('/mcp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        method: 'tools/call',
                        params: {
                            name: 'submit-lead',
                            arguments: formData,
                        },
                    }),
                });

                const result = await response.json();
                
                if (result.structuredContent?.leadId) {
                    successMessage.style.display = 'block';
                    errorMessage.style.display = 'none';
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeLeadModal();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Lead submission error:', error);
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Request';
            }
        }

        // Update result chip
        function updateResultChip() {
            const chip = el('resultChip');
            const count = el('resultCount');
            const location = el('resultLocation');

            if (state.vehicles.length > 0) {
                count.textContent = state.vehicles.length;
                location.textContent = state.query.location || 'Search Results';
                chip.style.display = 'block';
            } else {
                chip.style.display = 'none';
            }
        }

        // Sheet state management
        function setSheetState(newState) {
            state.sheetState = newState;
            const sheet = el('bottomSheet');
            const carousel = el('carousel');
            const list = el('list');

            sheet.className = `bottom-sheet ${newState}`;
            sheet.setAttribute('aria-expanded', newState !== 'collapsed');

            if (newState === 'collapsed') {
                carousel.style.display = 'flex';
                list.classList.add('hidden');
            } else {
                carousel.style.display = 'none';
                list.classList.remove('hidden');
            }

            logEvent('sheet_state', { state: newState });
        }

        // Event logging
        function logEvent(event, data) {
            console.log(JSON.stringify({ event, ...data }));
        }

        // Intersection observer for card visibility
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.dataset.id;
                        if (id && id !== state.activeId) {
                            setActiveVehicle(id);
                        }
                    }
                });
            }, { threshold: 0.5 });

            // Observe all cards when they're rendered
            setTimeout(() => {
                document.querySelectorAll('.vehicle-card').forEach(card => {
                    observer.observe(card);
                });
            }, 100);
        }

        // Event listeners
        function setupEventListeners() {
            // Sheet handle
            el('sheetHandle').addEventListener('click', () => {
                const nextState = state.sheetState === 'collapsed' ? 'mid' : 
                                state.sheetState === 'mid' ? 'expanded' : 'collapsed';
                setSheetState(nextState);
            });

            // Drawer close
            el('drawerClose').addEventListener('click', closeDetails);

            // Filter pills
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    const filter = pill.dataset.filter;
                    logEvent('filter_click', { filter });
                    console.log('Filter clicked:', filter);
                });
            });

            // Click backdrop to close drawer
            el('detailsDrawer').addEventListener('click', (e) => {
                if (e.target === el('detailsDrawer')) {
                    closeDetails();
                }
            });

            // Lead form submission
            el('leadForm').addEventListener('submit', submitLead);

            // Click backdrop to close lead modal
            el('leadModal').addEventListener('click', (e) => {
                if (e.target === el('leadModal')) {
                    closeLeadModal();
                }
            });
        }

        // Initialize app
        function init() {
            loadData();
            initMap();
            renderCards();
            updateResultChip();
            setupEventListeners();
            setupIntersectionObserver();
        }

        // Start the app
        init();

        // Make functions globally available
        window.openDetails = openDetails;
        window.bookTestDrive = bookTestDrive;
        window.getQuote = getQuote;
        window.callDealer = callDealer;
        window.getDirections = getDirections;
        window.closeLeadModal = closeLeadModal;
    </script>
</body>
</html>